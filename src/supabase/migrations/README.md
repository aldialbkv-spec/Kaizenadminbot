# üì¶ Database Migrations

–ú–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è Kaizen Center –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ.

## üî¢ –ü–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

–í—ã–ø–æ–ª–Ω—è—Ç—å —á–µ—Ä–µ–∑ **Supabase Dashboard ‚Üí SQL Editor** —Å—Ç—Ä–æ–≥–æ –ø–æ –ø–æ—Ä—è–¥–∫—É:

### 1Ô∏è‚É£ `001_initial_schema.sql`
**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –°–æ–∑–¥–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—É `test_history` –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ —Ç–µ—Å—Ç–æ–≤
- –î–æ–±–∞–≤–ª—è–µ—Ç –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

**–ö–æ–≥–¥–∞:** –ü—Ä–∏ –ø–µ—Ä–≤–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –ø—Ä–æ–µ–∫—Ç–∞

---

### 2Ô∏è‚É£ `002_add_user_id_to_test_history.sql`
**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –î–æ–±–∞–≤–ª—è–µ—Ç –ø–æ–ª–µ `user_id` –≤ —Ç–∞–±–ª–∏—Ü—É `test_history`
- –°–æ–∑–¥–∞–µ—Ç –∏–Ω–¥–µ–∫—Å –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Telegram ID –∏ Supabase UUID

**–ö–æ–≥–¥–∞:** –ü–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

---

### 3Ô∏è‚É£ `003_enable_auth.sql`
**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç Row Level Security (RLS)
- –°–æ–∑–¥–∞–µ—Ç –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º
- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é –ø–µ—Ä–≤–æ–≥–æ –∞–¥–º–∏–Ω–∞

**–ö–æ–≥–¥–∞:** –ü–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è user_id

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:** –°–æ–∑–¥–∞—Ç—å –∞–¥–º–∏–Ω–∞ —á–µ—Ä–µ–∑ Dashboard:
```
Dashboard ‚Üí Authentication ‚Üí Users ‚Üí Add User
Email: admin@example.com
Password: ********
```

---

### 4Ô∏è‚É£ `004_video_tutorials.sql`
**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –°–æ–∑–¥–∞–µ—Ç Storage bucket `tutorials` –¥–ª—è –≤–∏–¥–µ–æ
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ Storage
- –°–æ–∑–¥–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—ã `tutorials` –∏ `user_video_progress`
- –î–æ–±–∞–≤–ª—è–µ—Ç —Ç—Ä–∏–≥–≥–µ—Ä—ã –¥–ª—è auto-update –ø–æ–ª–µ–π

**–ö–æ–≥–¥–∞:** –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Å–∏—Å—Ç–µ–º—ã –≤–∏–¥–µ–æ-—Ç—É—Ç–æ—Ä–∏–∞–ª–æ–≤

**–ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏:**
1. –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ: Storage ‚Üí tutorials ‚Üí Upload
2. –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ: Table Editor ‚Üí tutorials ‚Üí Insert

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç (–≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ —Å—Ä–∞–∑—É)

```bash
# –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤–µ—Å—å –∫–æ–¥ –∏–∑ –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞ –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ –ø–æ—Ä—è–¥–∫—É:
# 1. 001_initial_schema.sql
# 2. 002_add_user_id_to_test_history.sql
# 3. 003_enable_auth.sql
# 4. 004_video_tutorials.sql
```

### –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø—Ä–æ–µ–∫—Ç (—Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ)

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–∞–∫–∏–µ —Ç–∞–±–ª–∏—Ü—ã —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç:
```sql
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public';
```

–ó–∞—Ç–µ–º –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Ç–æ–ª—å–∫–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏.

---

## üìä –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ö–µ–º–∞ –ë–î

–ü–æ—Å–ª–µ –≤—Å–µ—Ö –º–∏–≥—Ä–∞—Ü–∏–π —É –≤–∞—Å –±—É–¥–µ—Ç:

### –¢–∞–±–ª–∏—Ü—ã
- ‚úÖ `test_history` - –∏—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤/–æ—Ç—á–µ—Ç–æ–≤
- ‚úÖ `tutorials` - –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤–∏–¥–µ–æ-—Ç—É—Ç–æ—Ä–∏–∞–ª–æ–≤
- ‚úÖ `user_video_progress` - –ø—Ä–æ–≥—Ä–µ—Å—Å –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤–∏–¥–µ–æ

### Storage Buckets
- ‚úÖ `tutorials` - –ø—Ä–∏–≤–∞—Ç–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –≤–∏–¥–µ–æ

### –ò–Ω–¥–µ–∫—Å—ã
- ‚úÖ `idx_test_history_created_at` - —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ
- ‚úÖ `idx_test_history_type` - —Ñ–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É —Ç–µ—Å—Ç–∞
- ‚úÖ `idx_test_history_user_id` - —Ñ–∏–ª—å—Ç—Ä –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- ‚úÖ `idx_tutorials_order` - —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Ç—É—Ç–æ—Ä–∏–∞–ª–æ–≤
- ‚úÖ `idx_user_video_progress_user` - –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ `idx_user_video_progress_tutorial` - –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –≤–∏–¥–µ–æ

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### RLS (Row Level Security)
–í–∫–ª—é—á–µ–Ω –¥–ª—è `test_history`:
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ
- Service role (backend) –∏–º–µ–µ—Ç –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø
- –ê–¥–º–∏–Ω—ã –ø–æ–ª—É—á–∞—é—Ç –¥–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ backend API

### Storage Policies
Bucket `tutorials`:
- –ß—Ç–µ–Ω–∏–µ: –≤—Å–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
- –ó–∞–ø–∏—Å—å: —Ç–æ–ª—å–∫–æ service role (—á–µ—Ä–µ–∑ backend)

---

## ‚ö†Ô∏è –í–∞–∂–Ω–æ

1. **–ù–µ –≤—ã–ø–æ–ª–Ω—è—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ** - –æ–Ω–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç `IF NOT EXISTS` –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
2. **–°–æ–∑–¥–∞—Ç—å –±—ç–∫–∞–ø** –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º –º–∏–≥—Ä–∞—Ü–∏–π –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ
3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏** –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫
4. **–°–æ–∑–¥–∞—Ç—å –∞–¥–º–∏–Ω–∞** —á–µ—Ä–µ–∑ Dashboard –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ 003

---

## üêõ Troubleshooting

**–û—à–∏–±–∫–∞: "relation already exists"**
‚Üí –¢–∞–±–ª–∏—Ü–∞ —É–∂–µ —Å–æ–∑–¥–∞–Ω–∞, –ø—Ä–æ–ø—É—Å—Ç–∏—Ç–µ —ç—Ç—É –º–∏–≥—Ä–∞—Ü–∏—é

**–û—à–∏–±–∫–∞: "column already exists"**
‚Üí –ö–æ–ª–æ–Ω–∫–∞ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞, –ø—Ä–æ–ø—É—Å—Ç–∏—Ç–µ —ç—Ç—É –º–∏–≥—Ä–∞—Ü–∏—é

**RLS –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã**
‚Üí Backend –¥–æ–ª–∂–µ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å service_role –∫–ª—é—á, –Ω–µ anon –∫–ª—é—á

**Storage bucket –Ω–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è**
‚Üí –°–æ–∑–¥–∞–π—Ç–µ –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ Dashboard ‚Üí Storage ‚Üí New Bucket

---

## üìû Support

–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Supabase
2. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∫–ª—é—á–∏ (service_role –¥–ª—è backend)
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –≤—Å–µ environment variables –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã

–ì–æ—Ç–æ–≤–æ! üéâ
