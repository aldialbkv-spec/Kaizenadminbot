import type { VsmInput } from "./types.ts";

export function buildVsmPrompt(input: VsmInput): string {
  return `
Ты эксперт по Lean Manufacturing и Value Stream Mapping (Картированию потока создания ценности).

ВХОДНЫЕ ДАННЫЕ:
1. Название компании: ${input.companyName}
2. Чем занимается компания: ${input.companyActivity}
3. Процесс для улучшения: ${input.processToImprove}

ЗАДАЧА:
Проанализируй процесс компании "${input.companyName}" и создай подробный анализ потока создания ценности с учетом специфики их деятельности и отрасли. Верни результат в формате JSON со следующими полями:

1. "asIsMap" (массив объектов) - КПСЦ текущего состояния (As Is) с детализацией каждого этапа процесса ОТ ЗАПРОСА КЛИЕНТА ДО ПОЛУЧЕНИЯ КОНЕЧНОГО РЕЗУЛЬТАТА. 
   
   ВАЖНО: Опиши ВЕСЬ путь создания ценности включая:
   - Первый контакт с клиентом (как клиент делает запрос/заказ)
   - Все промежуточные этапы обработки, производства, логистики
   - Передачи между отделами/людьми
   - Точки ожидания и накопления незавершенного производства
   - Финальная доставка результата клиенту
   
   Для каждого этапа опиши РЕАЛЬНЫЕ проблемы и потери (ожидание, лишние движения, переделки, избыточные запасы).
   
   Каждый объект должен содержать:
   - "stage" (string) - Название этапа/операции (например: "Получение заказа от клиента", "Проверка наличия на складе", "Доставка клиенту")
   - "description" (string) - Подробное описание что происходит на этом этапе, кто участвует, какие документы/системы используются
   - "operationTime" (string) - Время ДОБАВЛЕНИЯ ЦЕННОСТИ в минутах (только время активной работы, например: "15", "120")
   - "waitTime" (string) - Время ОЖИДАНИЯ/НЕ ДОБАВЛЕНИЯ ЦЕННОСТИ в минутах (простои, очереди, пролеживание, например: "480", "1440")
   - "responsible" (string) - Должность/роль ответственного (например: "Менеджер по продажам", "Кладовщик", "Водитель")
   - "problems" (string) - Конкретные потери и проблемы на этом этапе (ожидания, переделки, ненужные движения, избыточные проверки)
   - "addsValue" (string) - Добавляет ли операция ценность для клиента: "Да" или "Нет"
   - "hasWaste" (string) - Присутствуют ли потери на этом этапе: "Да" или "Нет"
   
   Создай СТОЛЬКО этапов, СКОЛЬКО РЕАЛЬНО СУЩЕСТВУЕТ в описанном процессе. Не пропускай ни одного шага - опиши ВСЕ этапы от первого контакта с клиентом до получения им конечного результата.
   
   В конце массива добавь итоговую строку с суммарными показателями:
   - stage: "ИТОГО"
   - description: "Общее время цикла и коэффициент создания ценности"
   - operationTime: сумма всех операционных времен
   - waitTime: сумма всех времен ожидания
   - responsible: "—"
   - problems: "Коэффициент создания ценности: X% (время операций / общее время цикла)"
   - addsValue: "—"
   - hasWaste: "—"
   
2. "operatorLoad" (массив объектов) - Диаграмма загрузки операторов для выявления неравномерности работы. Создай объект для КАЖДОГО оператора/должности из asIsMap:
   - "operator" (string) - Название оператора/должность (например: "Менеджер по продажам", "Кладовщик")
   - "usefulLoad" (number) - Полезная загрузка в минутах (суммарное время добавления ценности для этого оператора)
   - "waste" (number) - Потери в минутах (суммарное время ожидания и непродуктивной работы для этого оператора)
   - "comment" (string) - Комментарий о характере работы, проблемах загрузки, пиках и простоях

3. "spaghettiDiagram" (объект) - Диаграмма спагетти с визуализацией перемещений и лишних движений. Структура:
   - "zones" (массив объектов) - Зоны/локации в ��роцессе:
     * "id" (string) - Уникальный идентификатор зоны (например: "zone1", "zone2")
     * "name" (string) - Название зоны (например: "Склад сырья", "Офис менеджера", "Производство")
     * "type" (string) - Тип зоны: "storage" (склад), "office" (офис), "production" (производство), "warehouse" (склад готовой продукции)
   - "routes" (массив объектов) - Маршруты перемещений между зонами:
     * "from" (string) - ID зоны откуда (должен совпадать с id из zones)
     * "to" (string) - ID зоны куда (должен совпадать с id из zones)
     * "distance" (string) - Расстояние перемещения (например: "50 метров", "2 этажа")
     * "frequency" (string) - Частота перемещений (например: "10 раз/день", "Постоянно")
     * "wasteType" (string) - Тип потерь: "transport" (транспортировка), "motion" (лишние движения), "waiting" (ожидание)
     * "description" (string) - Описание проблемы (например: "Частые походы за документами")
   - "summary" (string) - Общий текстовый анализ: общее расстояние перемещений за цикл, основные проблемные маршруты, рекомендации по оптимизации

4. "wasteTable" (string) - Таблица проблем текущего состояния по 7 видам потерь (муда). Для каждого типа потерь укажи конкретные примеры:
   - Перепроизводство
   - Ожидание
   - Транспортировка
   - Излишняя обработка
   - Избыточные запасы
   - Лишние движения
   - Дефекты
   Форматируй как читаемую таблицу или список.

5. "jitMeasures" (массив объектов) - План конкретных мероприятий для внедрения системы "Точно вовремя" (Just in Time). 

ОБЯЗАТЕЛЬНО применяй 8 принципов потока при разработке мероприятий:

**Принцип 1** – Производство в соответствии с временем такта
**Принцип 2** – Разработка непрерывного потока везде, где это возможно
**Принцип 3** – Производство единичных изделий
**Принцип 4** – Применение стандартного минимального запаса под операцию
**Принцип 5** – Использование принципа супермаркета
**Принцип 6** – FIFO (First In First Out)
**Принцип 7** – Балансировка
**Принцип 8** – Вытягивание

Создай 4-8 мероприятий с учетом специфики компании "${input.companyName}" и их процессов. Каждый объект должен содержать:
- "principle" (string) - Применяемый принцип потока в формате "Принцип N – Название" (например: "Принцип 1 – Производство в соответствии с временем такта")
- "action" (string) - Конкретное действие/мероприятие, адаптированное под компанию (например: "Определить оптимальный такт для обработки заявок")
- "deadline" (string) - Срок внедрения (например: "1 месяц", "2 недели")
- "responsible" (string) - Ответственный за внедрение с учетом структуры компании (например: "Руководитель производства", "Менеджер по продажам")
- "expectedResult" (string) - Ожидаемый результат от внедрения (например: "Сокращение времени ожидания на 50%")

6. "toBeMap" (string) - Подробное описание КПСЦ будущего состояния (To Be) для компании "${input.companyName}" с улучшенными показателями и сокращённым временем цикла. Опиши целевое состояние процесса после внедрения улучшений с учетом их специфики деятельности, укажи конкретные метрики улучшения.

ВАЖНО:
- Поля "asIsMap", "operatorLoad", "jitMeasures" должны быть МАССИВАМИ ОБЪЕКТОВ с указанными полями
- Поле "spaghettiDiagram" должно быть ОБЪЕКТОМ с полями zones (массив), routes (массив), summary (строка)
- Время указывай ТОЛЬКО в минутах как число-строку для asIsMap (наприм��р "15", "120", а не "15 мин" или "2 часа")
- В operatorLoad поля usefulLoad и waste должны быть ЧИСЛАМИ в минутах (number), а не строками
- Для каждого оператора суммируй ВСЕ его operationTime (для usefulLoad) и ВСЕ его waitTime (для waste) из asIsMap
- В spaghettiDiagram создай 4-7 зон и 5-10 маршрутов между ними, основываясь на asIsMap
- ID зон должны быть уникальными (zone1, zone2, и т.д.) и совпадать в routes
- Остальные поля должны быть СТРОКАМИ (string)
- Будь конкретным и практичным
- Используй реальные примеры для данной отрасли
- Указывай конкретные числа и метрики
- Используй переносы строк \\\\n для ф��рматирования текста в строковых полях
- Формат ответа: чистый JSON без markdown, без комментариев

Пример формата ответа:
{
  "asIsMap": [
    {
      "stage": "Получение заказа",
      "description": "Клиент ос��авляет заявку через форму на сайте или по телефону",
      "operationTime": "10",
      "waitTime": "120",
      "responsible": "Менеджер по продажам",
      "problems": "Отсутствие автоматизации, долгое ожидание обработки",
      "addsValue": "Да",
      "hasWaste": "Да"
    },
    {
      "stage": "Обработка заказа",
      "description": "Проверка наличия товара на складе и формирование комплектации",
      "operationTime": "15",
      "waitTime": "60",
      "responsible": "Кладовщик",
      "problems": "Ручной учет, неточности в остатках",
      "addsValue": "Да",
      "hasWaste": "Да"
    }
  ],
  "operatorLoad": [
    {
      "operator": "Менеджер по продажам",
      "usefulLoad": 25,
      "waste": 180,
      "comment": "Значительное время тратится на ожидание ответов от клиентов и поиск информации в разных системах"
    },
    {
      "operator": "Кладовщик",
      "usefulLoad": 30,
      "waste": 90,
      "comment": "Большие потери из-за ручного учета, перемещений по складу и ожидания транспорта"
    }
  ],
  "spaghettiDiagram": {
    "zones": [
      {
        "id": "zone1",
        "name": "Офис менеджера",
        "type": "office"
      },
      {
        "id": "zone2",
        "name": "Склад документов",
        "type": "storage"
      },
      {
        "id": "zone3",
        "name": "Склад товаров",
        "type": "warehouse"
      }
    ],
    "routes": [
      {
        "from": "zone1",
        "to": "zone2",
        "distance": "50 метров",
        "frequency": "8 раз/день",
        "wasteType": "motion",
        "description": "Частые походы за документами из-за отсутствия электронного документооборота"
      },
      {
        "from": "zone2",
        "to": "zone3",
        "distance": "100 метров",
        "frequency": "5 раз/день",
        "wasteType": "transport",
        "description": "Перенос документов на склад для сверки"
      }
    ],
    "summary": "Общее расстояние перемещений за цикл: ~900 метров. Основная проблема - отсутствие электронного документооборота приводит к частым перемещениям между офисом и складом. Рекомендуется внедрить CRM-систему и объединить зоны хранения документов."
  },
  "wasteTable": "...",
  "jitMeasures": [
    {
      "principle": "Принцип 1 – Производство в соответствии с временем такта",
      "action": "Определить оптимальный такт для обработки заявок клиентов",
      "deadline": "1 месяц",
      "responsible": "Менеджер по продажам",
      "expectedResult": "Сокращение времени ожидания на 50%"
    }
  ],
  "toBeMap": "..."
}
`;
}
