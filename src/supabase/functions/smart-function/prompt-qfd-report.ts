import type { CustomerRequirement, TechnicalCharacteristic } from '../types.ts';

export function createQFDReportPrompt(
  companyDescription: string,
  customerRequirements: CustomerRequirement[],
  technicalCharacteristics: TechnicalCharacteristic[],
  competitorsEnabled: boolean,
  competitors?: { competitor1?: string; competitor2?: string; competitor3?: string }
): string {
  const requirementsList = customerRequirements
    .map((req, i) => `${i + 1}. [${req.category}] ${req.text}`)
    .join('\n');

  const characteristicsList = technicalCharacteristics
    .map((tech, i) => `${i + 1}. [${tech.category}] ${tech.text} — ${tech.unit} — ${tech.direction}`)
    .join('\n');

  const competitorSection = competitorsEnabled && competitors
    ? `
КОНКУРЕНТНЫЙ АНАЛИЗ ВКЛЮЧЕН:
Конкурент 1: ${competitors.competitor1 || 'Не указан'}
Конкурент 2: ${competitors.competitor2 || 'Не указан'}
Конкурент 3: ${competitors.competitor3 || 'Не указан'}
`
    : 'КОНКУРЕНТНЫЙ АНАЛИЗ ОТКЛЮЧЕН';

  return `Ты — эксперт по Quality Function Deployment (QFD). Твоя задача — создать полный Дом качества на основе утвержденных требований клиентов и технических характеристик.

ФИЛОСОФИЯ QFD:
Качество в методе QFD — это степень соответствия продукта/услуги ожиданиям и требованиям клиента, выраженным на ЯЗЫКЕ КЛИЕНТА. Это удовлетворенность клиента его приоритетными ожиданиями, которые системно трансформируются в технические характеристики продукта. В доме качества требования клиента (Whats) отображаются слева, способы их достижения (Hows) — сверху, и согласованность этих параметров формирует понятие качества продукта.

ВХОДНЫЕ ДАННЫЕ:

Описание компании и продукта: ${companyDescription}

ТРЕБОВАНИЯ КЛИЕНТОВ (WHATs) — выражены на языке клиента:
${requirementsList}

ТЕХНИЧЕСКИЕ ХАРАКТЕРИСТИКИ (HOWs) — способы достижения требований:
${characteristicsList}

${competitorSection}

---

ЗАДАЧА:
Создай полный QFD анализ в структурированном JSON формате со следующими разделами:

---

## 1. ОЦЕНКА ВАЖНОСТИ ТРЕБОВАНИЙ КЛИЕНТОВ

Для каждого требования клиента определи ВАЖНОСТЬ С ТОЧКИ ЗРЕНИЯ КЛИЕНТА (не компании!):
- Оценку важности: число от 1 до 10 (10 = самое важное для клиента, 1 = наименее важное)
- Относительную важность в % на основе оценки (сумма должна быть 100%)

КРИТИЧЕСКИ ВАЖНО: 
- КАЖДОЕ требование должно иметь УНИКАЛЬНОЕ значение важности
- НЕ ДОПУСКАЮТСЯ повторяющиеся значения (например, два требования с важностью 10)
- Используй весь диапазон от 1 до 10 для ранжирования
- Если требований 8, используй значения: 10, 9, 8, 7, 6, 5, 4, 3 (по одному на каждое требование)
- Самое важное ДЛЯ КЛИЕНТА требование = 10, следующее = 9, и так далее в порядке убывания
- Анализируй с позиции клиента: что для него критично, что желательно, что второстепенно
- Учитывай типичные приоритеты клиентов в данной отрасли (надежность, безопасность, удобство, функциональность, качество исполнения, сервис и т.д.)
- ВАЖНО: Оценивай только качественные требования, не учитывай цену/стоимость — это не часть QFD анализа

---

## 2. МАТРИЦА ВЗАИМОСВЯЗЕЙ (системная трансформация требований в характеристики)

Оцени силу влияния каждой технической характеристики (How) на каждое требование клиента (What).
Это ключевая часть QFD — здесь происходит трансформация ожиданий клиента в технические параметры продукта.

СИСТЕМА ОЦЕНКИ:
- "9" = Сильная связь — техническая характеристика напрямую и сильно влияет на удовлетворение требования клиента
- "3" = Средняя связь — есть заметное влияние на удовлетворение требования
- "1" = Слабая связь — косвенное или незначительное влияние на требование
- "" = Нет связи (пустая строка) — характеристика не влияет на данное требование

ПРИНЦИПЫ ЗАПОЛНЕНИЯ:
- Будь избирательным: не все характеристики влияют на все требования
- Используй пустые значения для отсутствия связи — это нормально и правильно
- Сильных связей (9) должно быть меньше, чем средних (3) и слабых (1)
- Фокусируйся на реальном влиянии технической характеристики на удовлетворенность клиента этим требованием

---

## 3. РЕЙТИНГ ВАЖНОСТИ ТЕХНИЧЕСКИХ ХАРАКТЕРИСТИК

Рассчитай для каждой технической характеристики:
- Абсолютный вес = Σ(Важность требования × Сила связи из матрицы)
- Относительный вес в %
- Ранг (1 = самая важная)

---

## 4. КОРРЕЛЯЦИОННАЯ МАТРИЦА (КРЫША ДОМА)

Проанализируй взаимодействие между техническими характеристиками.

СИСТЕМА ОЦЕНКИ:
- "++" = Сильная положительная корреляция (синергия: улучшение одного автоматически улучшает другое)
- "+" = Положительная корреляция
- "-" = Отрицательная корреляция (trade-off: улучшение одного ухудшает другое)
- "--" = Сильная отрицательная корреляция (конфликт)

Определи 5-7 наиболее важных корреляций с объяснением их стратегического значения.
Обрати особое внимание на отрицательные корреляции — это критические компромиссы.

---

## 5. КОНКУРЕНТНЫЙ АНАЛИЗ
${competitorsEnabled ? `
[ВКЛЮЧЕН]

Оцени по шкале 1-5 (5 = отлично удовлетворяет требование):
- Наш продукт (текущее состояние)
- Каждый конкурент

Рассчитай "На сколько улучшать" для каждого требования:
- Если наш продукт хуже лучшего конкурента: (Лучший конкурент) - (Наш продукт)
- Если наш продукт лучше или равен всем конкурентам: null (не требуется улучшение)

ВАЖНО: 
- Поле "improvementNeeded" должно быть числом (1, 2, 3...) если нужно улучшение
- Поле "improvementNeeded" должно быть null если наш продукт уже лучший или равен лучшему
- НЕ используй отрицательные значения

Проанализируй:
- Наши сильные стороны (где наша оценка >= всех конкурентов)
- Отставания (где improvementNeeded > 0)
- Возможности для дифференциации
` : '[ПРОПУСТИТЬ ЭТОТ РАЗДЕЛ]'}

---

## 6. ПЛАН ДЕЙСТВИЙ ДЛЯ ТОП-3 ХАРАКТЕРИСТИК

Выбери ТРИ технические характеристики с наибольшим весом (ранг 1, 2, 3).

Для каждой характеристики создай 2-3 конкретных действия/задачи для её улучшения.

Для каждого действия укажи:
- Конкретное описание действия (что именно нужно сделать)
- ID требований клиентов, на которые влияет это действие (массив)
- ID технической характеристики
- Ожидаемое влияние в числовом выражении (например, улучшение на 20%, снижение на 15%, увеличение на 30%)
- Срок реализации (например, "2-3 недели", "1 месяц", "6-8 недель")
- Ответственный отдел/команда (например, "Отдел разработки", "Производство", "Маркетинг", "Служба качества")

ВАЖНО: 
- Действия должны быть конкретными и выполнимыми
- Влияние должно быть реалистичным
- Сроки должны учитывать сложность задачи
- Всего должно быть 6-9 действий (по 2-3 для каждой из топ-3 характеристик)

---

ФОРМАТ ОТВЕТА (строго JSON):
{
  "customerRequirements": [
    {
      "id": "req1",
      "text": "...",
      "category": "...",
      "importance": 8,
      "relativeImportance": 12.5
    }
  ],
  "technicalCharacteristics": [
    {
      "id": "tech1",
      "text": "...",
      "category": "...",
      "unit": "...",
      "direction": "↑",
      "absoluteWeight": 72,
      "relativeWeight": 15.3,
      "rank": 1
    }
  ],
  "relationshipMatrix": {
    "req1_tech1": "9",
    "req1_tech2": "3",
    "req2_tech1": "1",
    "req2_tech3": ""
  },
  "correlations": [
    {
      "characteristic1Id": "tech1",
      "characteristic2Id": "tech2",
      "type": "++",
      "description": "Улучшение скорости автоматически улучшает производительность"
    }
  ],
  ${competitorsEnabled ? `"competitiveRatings": [
    {
      "requirementId": "req1",
      "ourProduct": 3,
      "competitor1": 4,
      "competitor2": 3,
      "competitor3": 5,
      "improvementNeeded": 2
    },
    {
      "requirementId": "req2",
      "ourProduct": 5,
      "competitor1": 4,
      "competitor2": 4,
      "competitor3": 3,
      "improvementNeeded": null
    }
  ],
  "competitiveStrategy": {
    "strengths": ["Описание сильных сторон"],
    "gaps": ["Описание отставаний"],
    "opportunities": ["Возможности для дифференциации"]
  },` : ''}
  "actions": [
    {
      "id": "action1",
      "action": "Оптимизировать алгоритм обработки данных",
      "requirementIds": ["req1", "req2"],
      "characteristicId": "tech1",
      "impact": 25,
      "duration": "3-4 недели",
      "responsible": "Отдел разработки"
    }
  ]
}

ПРИНЦИПЫ РАБОТЫ:
1. Помни философию QFD: качество = удовлетворенность клиента его приоритетными ожиданиями
2. Все оценки важности делай С ТОЧКИ ЗРЕНИЯ КЛИЕНТА, а не компании
3. Матрица взаимосвязей — это системная трансформация требований (Whats) в характеристики (Hows)
4. Все оценки должны быть обоснованными для данной индустрии и реалистичными
5. Математика должна сходиться (проценты в сумме = 100%, расчеты весов корректны)
6. Фокус на actionable insights: анализ должен давать конкретные направления для улучшения продукта
7. Учитывай реальные ограничения и возможности компании при формировании плана действий
8. ${competitorsEnabled ? 'Конкурентный анализ должен быть объективным и реалистичным' : 'Конкурентный анализ пропускаем полностью'}
9. Возвращай ТОЛЬКО валидный JSON без markdown разметки

Создай полный QFD анализ в формате JSON, который поможет компании системно трансформировать ожидания клиентов в технические характеристики продукта и конкретные действия по улучшению качества.`;
}
