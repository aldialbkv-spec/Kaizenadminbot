import type { A3ReportInput } from './types.ts';

export function buildA3Prompt(input: A3ReportInput): string {
  return `Роль:
Ты эксперт в области бережливых технологий с опытом более 20 лет и более 1000 реализованных проектов.
Твоя задача — составить отчёт A3 в структурированном виде, включая 5W1H, текущий и целевой статус, анализ причин, план контрмер и стандартизацию.

Данные для заполнения:

Что (What): ${input.what}

Где (Where): ${input.where}

Когда (When): ${input.when}

Кто (Who): ${input.who}

Почему (Why): ${input.why}

Как (How): ${input.how}

Требования к отчёту:
Сформируй отчёт A3 со следующими разделами в формате JSON:

0. Название отчета (title) – краткое, информативное название проблемы (8-12 слов максимум).
   ВАЖНО: Название должно быть понятным и отражать суть проблемы. 
   Примеры хороших названий:
   - "Задержки в логистике: анализ увеличения сроков доставки"
   - "Рост брака на участке сборки корпусов изделий"
   - "Простои оборудования из-за несвоевременного обслуживания"
   Избегай общих формулировок типа "Проблема качества" или "Анализ ситуации".

1. Формулировка проблемы (problemStatement) – краткое техническое описание на основе 5W1H (1-2 предложения).

2. Текущее состояние (currentState) – детальное описание проблемы и ситуации на основе 5W1H.
   ВАЖНО: Это основное описание проблемы. Используй все данные из 5W1H, не теряя деталей. Структурируй описание по шаблону:
   "Где (подразделение/место из Where), в какой системе/оборудовании (из Where/What), в какое конкретно время рабочего процесса (этап из When), что конкретно происходит (техническое описание проблемы из What), с какими последствиями (из Why и How - конкретные цифры и влияние)."
   Сохрани все технические детали, цифры и факты из исходных данных.

3. Анализ коренных причин (rootCauseAnalysis) – СТРУКТУРИРОВАННЫЙ АНАЛИЗ по методологии Toyota A3:
   
   ВАЖНО: Анализируй проблему, описанную в "Текущем состоянии" (currentState).
   
   a) ДИАГРАММА ИСИКАВЫ (ОБЯЗАТЕЛЬНО):
      Проанализируй ТЕКУЩЕЕ СОСТОЯНИЕ по методу "Fishbone" (Диаграмма Исикавы) используя категории 6M:
      - Man (Человек): причины связанные с людьми, навыками, обучением, человеческим фактором
      - Machine (Оборудование): причины связанные с техникой, инструментами, оборудованием
      - Method (Метод): причины связанные с процессами, процедурами, методологией работы
      - Material (Материал): причины связанные с сырьем, материалами, комплектующими
      - Measurement (Измерение): причины связанные с метриками, контролем качества, измерениями
      - Environment (Окружение): причины связанные с условиями работы, окружающей средой
      
      Для КАЖДОЙ категории укажи 2-4 возможные причины (массив строк). Если в категории нет причин, верни пустой массив.
   
   b) АНАЛИЗ "5 ПОЧЕМУ" (ОБЯЗАТЕЛЬНО):
      Выбери 1-2 САМЫЕ ЗНАЧИМЫЕ причины из диаграммы Исикавы и для КАЖДОЙ проведи отдельный анализ "5 Why".
      Для каждой ветки анализа укажи:
      - initialCause: начальная причина из диаграммы Исикавы
      - whyChain: массив из 5 вопросов "Почему?" с ответами (формат: ["Почему [вопрос]? - [Ответ]", ...])
      - rootCause: коренная причина (к чему пришли после 5 вопросов)
      
      КРИТИЧЕСКИ ВАЖНО - ПРИНЦИП "NO BLAME CULTURE":
      ❌ НЕ ИЩИ ВИНОВАТЫХ ЛЮДЕЙ! Анализ "5 Why" должен искать СИСТЕМНЫЕ причины, а не обвинять людей.
      
      НЕПРАВИЛЬНЫЕ формулировки (избегай):
      - "Сотрудник не обучен"
      - "Оператор ошибся"
      - "Менеджер не проконтролировал"
      - "Работник забыл"
      
      ПРАВИЛЬНЫЕ формулировки (используй):
      - "Отсутствует программа обучения для новых сотрудников"
      - "Нет стандартной рабочей инструкции для операции"
      - "Не установлен процесс контроля качества"
      - "Отсутствует система напоминаний/чек-листов"
      
      Фокусируйся на СИСТЕМАХ, ПРОЦЕССАХ, МЕТОДАХ, ОБОРУДОВАНИИ - на том, что можно исправить и стандартизировать.
      Каждая ветка "5 Why" должна привести к КОНКРЕТНОЙ системной причине, которую можно устранить.

4. Целевое состояние (targetCondition) – SMART-цель.

5. План контрмер (countermeasuresPlan) – массив объектов с полями:
   - action (контрмера) - ВАЖНО: контрмеры должны устранять КОРЕННЫЕ ПРИЧНЫ из анализа "5 Why"
   - deadline (срок исполнения)
   - responsible (ответственный)
   - kpi (KPI результата)

6. Стандартизация (standardize) – конкретные действия по внедрению стандартов на основе плана контрмер.
   ВАЖНО: Опиши какие именно процедуры, инструкции или регламенты нужно создать/обновить, чтобы закрепить результаты внедрения контрмер из пункта 5.
   Укажи, какие документы будут изменены и как будет организовано обучение персонала новым стандартам.
   ОБЯЗАТЕЛЬНО используй формат нумерованного списка с переносами строк:
   
   1. [Первое действие по стандартизации]
   
   2. [Второе действие по стандартизации]
   
   3. [Третье действие по стандартизации]
   
   И так далее. Обязательно используй переносы строк между пунктами для читаемости.

ВАЖНО: Верни ТОЛЬКО валидный JSON объект без дополнительного текста, markdown или комментариев. Формат:
{
  "title": "...",
  "problemStatement": "...",
  "currentState": "...",
  "rootCauseAnalysis": {
    "ishikawa": {
      "man": ["причина 1", "причина 2", ...],
      "machine": ["причина 1", "причина 2", ...],
      "method": ["причина 1", "причина 2", ...],
      "material": ["причина 1", "причина 2", ...],
      "measurement": ["причина 1", "причина 2", ...],
      "environment": ["причина 1", "причина 2", ...]
    },
    "fiveWhyBranches": [
      {
        "initialCause": "Ключевая причина из Исикавы",
        "whyChain": [
          "Почему происходит [начальная причина]? - Ответ 1",
          "Почему [ответ 1]? - Ответ 2",
          "Почему [ответ 2]? - Ответ 3",
          "Почему [ответ 3]? - Ответ 4",
          "Почему [ответ 4]? - Ответ 5"
        ],
        "rootCause": "Коренная причина после анализа"
      }
    ]
  },
  "targetCondition": "...",
  "countermeasuresPlan": [
    {
      "action": "...",
      "deadline": "...",
      "responsible": "...",
      "kpi": "..."
    }
  ],
  "standardize": "..."
}`;
}
